<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIVOT Portability - Enhanced UI</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f6f8fb; font-family:Inter,system-ui,Arial }
  .card { border-radius:12px; padding:20px; }
  .brand-right img.pivot { height:150px; }
  button.active { box-shadow:0 0 0 3px rgba(59,130,246,0.15); }
  .small-muted { color:#6b7280; }
  .decision-box { border-radius:8px; padding:12px; background:#fffbeb; border:1px solid #fcd34d; }
</style>
</head>
<body>
<div class="container py-4">
  <div class="card p-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div><img src="company_logo.png" alt="Company" style="height:72px;"></div>
      <div style="text-align:center">
        <div style="font-size:.85rem;color:#6b7280">Product</div>
        <div style="font-weight:700;font-size:1.2rem">PIVOT Portability module</div>
      </div>
      <div><img src="pivot_logo.png" alt="PIVOT" class="pivot" style="height:150px;"></div>
    </div>

    <hr>

    <form id="demoForm" class="row g-2 align-items-end mb-3">
      <div class="col-md-4">
        <label class="form-label">Insurance company <span class="small text-muted">(optional)</span></label>
        <input id="insurance_company" class="form-control" placeholder="e.g. Star">
      </div>

      <div class="col-md-5">
        <label class="form-label">File</label>
        <input id="input_file" type="file" class="form-control">
        <div id="fileInfo" class="form-text"></div>
      </div>

      <div class="col-md-3 d-grid">
        <button id="showClassic" class="btn btn-outline-primary mb-1">Show Classic</button>
        <button id="showEnhanced" class="btn btn-primary">Show Enhanced Here</button>
      </div>
    </form>

    <div id="alerts"></div>

    <div class="row">
      <div class="col-md-4">
        <div class="text-center">
          <div id="scoreRing" style="width:120px;height:120px;border-radius:50%;border:8px solid #f59e0b;display:flex;align-items:center;justify-content:center;margin:0 auto">--%</div>
          <div id="decideBadge"></div>
          <div class="small-muted mt-2">Underwriter Score</div>
        </div>

        <div class="mt-3 decision-box">
          <div class="d-flex justify-content-between">
            <div>
              <strong id="decisionLabel">REVIEW</strong>
              <div class="small-muted">Recommended Action</div>
            </div>
            <div id="decisionAction" style="font-weight:700">Check continuity & nominee</div>
          </div>
        </div>

        <div class="mt-3 controls">
          <button id="approveBtn" class="btn btn-success w-100">Approve</button>
          <button id="flagBtn" class="btn btn-warning w-100 mt-2">Flag for manual review</button>
          <button id="exportPdf" class="btn btn-outline-secondary w-100 mt-2">Export Underwriting Summary (Print/PDF)</button>
          <a id="downloadJson" class="btn btn-sm btn-outline-secondary w-100 mt-2" download>Download JSON</a>
        </div>
      </div>

      <div class="col-md-8">
        <h5>Policy summary</h5>
        <div class="card p-3 mb-3" id="policyCard">
          <div class="d-flex justify-content-between">
            <div>
              <div style="font-size:.9rem">Product</div>
              <div id="productName" class="small-muted"></div>
            </div>
            <div>
              <div style="font-size:.9rem">Company</div>
              <div id="companyTop" class="small-muted"></div>
            </div>
          </div>

          <hr>

          <div class="row">
            <div class="col-md-6">
              <div><strong>Policy number</strong><div id="policyNumber" class="small-muted"></div></div>
              <div class="mt-2"><strong>Period</strong><div id="policyPeriod" class="small-muted"></div></div>
            </div>
            <div class="col-md-6">
              <div><strong>Policy type</strong><div id="policyType" class="small-muted"></div></div>
              <div class="mt-2"><strong>Term</strong><div id="policyTerm" class="small-muted"></div></div>
            </div>
            <div class="col-12 mt-2"><strong>Sum Insured</strong><div id="sumInsured" class="small-muted"></div></div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-7">
            <h6>Proposer</h6>
            <div class="card p-3 mb-3" id="proposerCard">
              <div id="proposerName" class="fw-semibold"></div>
              <div class="small-muted" id="proposerContact"></div>
              <div class="mt-2" id="proposerAddress"></div>
            </div>

            <h6>Insured members</h6>
            <div id="insuredList"></div>

            <h6 class="mt-3">Nominee</h6>
            <div id="nomineeCard" class="card p-3"></div>
          </div>

          <div class="col-md-5">
            <h6>Risk summary</h6>
            <div class="card p-3 mb-3"><div id="riskBadges" class="d-flex flex-column gap-2"></div></div>

            <h6>Validation & checks</h6>
            <div id="checksList" class="checks-list mb-3"></div>
          </div>
        </div>

        <details class="mt-2"><summary class="small-muted">Raw API JSON</summary>
          <pre id="rawJson" class="mt-2 bg-light p-2 rounded" style="max-height:300px; overflow:auto"></pre>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
function setActiveButton(activeId){
  ['showClassic','showEnhanced'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    if(id===activeId) el.classList.add('active');
    else el.classList.remove('active');
  });
}

function computeScore(data){
  try{ if(typeof window.computeScore === 'function') return window.computeScore(data); } catch(e){}
  return { score: 70, breakdown:{} };
}

function renderResponse(resp){
  const data = resp?.response?.data || resp || {};
  document.getElementById('productName').textContent = data.policy_and_coverage_details?.policy_product_name || 'â€”';
  document.getElementById('companyTop').textContent = data.policy_and_coverage_details?.optional_coverage_5 || data.optional_coverage_5 || 'â€”';
  document.getElementById('policyNumber').textContent = data.policy_and_coverage_details?.policy_number || 'â€”';
  document.getElementById('policyPeriod').textContent = (data.policy_and_coverage_details?.policy_start_date||'â€”') + ' â†’ ' + (data.policy_and_coverage_details?.policy_end_date||'â€”');
  document.getElementById('policyType').textContent = data.policy_and_coverage_details?.policy_type || 'â€”';
  document.getElementById('policyTerm').textContent = data.policy_and_coverage_details?.policy_term || 'â€”';
  document.getElementById('sumInsured').textContent = data.policy_and_coverage_details?.floater_basic_sum_insured || (data.insured_details && data.insured_details[0]?.individual_policy_sum_insured) || 'â€”';

  const p = data.proposer_details || {};
  document.getElementById('proposerName').textContent = [p.title,p.first_name,p.last_name].filter(Boolean).join(' ')||'â€”';
  document.getElementById('proposerContact').textContent = (p.mobile_number? 'ðŸ“ž ' + p.mobile_number : '') + (p.email? ' âœ‰ ' + p.email : '');
  document.getElementById('proposerAddress').textContent = (p.address||'') + ' ' + (p.city||'');

  const insList = document.getElementById('insuredList'); insList.innerHTML='';
  (data.insured_details||[]).forEach(ins=>{
    const d=document.createElement('div'); d.className='card p-2 mb-2';
    d.innerHTML = `<div class="d-flex justify-content-between"><div><strong>${ins.insured_name||'â€”'}</strong><div class="small-muted">${ins.relationship||'â€”'} â€¢ DOB: ${ins.dob||'â€”'}</div></div><div class="text-end"><div>First started: ${ins.first_policy_started||'â€”'}</div><div>Age: ${ins.age||'â€”'}</div></div></div><div class="mt-2 small-muted">PED: ${ins.declared_ped||'â€”'}</div>`;
    insList.appendChild(d);
  });

  const rb=document.getElementById('riskBadges'); rb.innerHTML='';
  if(data.insured_details && data.insured_details.length>0){
    const ins0 = data.insured_details[0];
    const span=document.createElement('span'); span.className='badge bg-light text-dark'; span.textContent = 'Insured: ' + (ins0.insured_name||'â€”'); rb.appendChild(span);
  }

  const checks = document.getElementById('checksList'); checks.innerHTML='';
  if(!data.policy_and_coverage_details?.policy_number) checks.innerHTML += '<div class="p-2 mb-1 bg-danger text-white">Missing policy number</div>';
  if(!data.policy_and_coverage_details?.floater_basic_sum_insured && !(data.insured_details && data.insured_details[0]?.individual_policy_sum_insured)) checks.innerHTML += '<div class="p-2 mb-1 bg-warning text-dark">Sum insured is missing</div>';

  const sc = computeScore(data);
  document.getElementById('scoreRing').textContent = sc.score + '%';
  document.getElementById('rawJson').textContent = JSON.stringify(resp,null,2);

  if(sc.score >= 85){ document.getElementById('decisionLabel').textContent='ACCEPT'; document.getElementById('decisionAction').textContent='Auto-approve'; }
  else if(sc.score >= 65){ document.getElementById('decisionLabel').textContent='REVIEW'; document.getElementById('decisionAction').textContent='Manual review suggested'; }
  else { document.getElementById('decisionLabel').textContent='REJECT / NEEDS DATA'; document.getElementById('decisionAction').textContent='Reject or request missing data'; }

  setActiveButton('showEnhanced');
}

async function postAndAction(target){
  const f=document.getElementById('input_file').files[0];
  const ins=document.getElementById('insurance_company').value || '';
  if(!f){ alert('Please choose a file'); return; }
  const fd=new FormData(); fd.append('input_file', f); if(ins) fd.append('insurance_company', ins);

  const btn = (target==='here') ? document.getElementById('showEnhanced') : document.getElementById('showClassic');
  const orig=btn.textContent; btn.disabled=true; btn.textContent='Sending...';

  try{
    const r = await fetch('/forward', { method:'POST', body: fd });
    const text = await r.text();
    let json=null; try{ json = JSON.parse(text); } catch(e){ json = text; }
    if(!r.ok){ document.getElementById('alerts').innerHTML = `<div class="alert alert-danger">Error ${r.status}: <pre>${JSON.stringify(json,null,2)}</pre></div>`; return; }
    if(target==='here'){ renderResponse(json); }
    else { try{ sessionStorage.setItem('lastExtraction', JSON.stringify(json)); }catch(e){}; window.location.href='policy-ui.html'; }
  }catch(err){
    document.getElementById('alerts').innerHTML = `<div class="alert alert-danger">Network: ${err.message}</div>`;
  }finally{ btn.disabled=false; btn.textContent=orig; }
}

document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('showClassic').addEventListener('click', function(ev){ ev.preventDefault(); postAndAction('other'); });
  document.getElementById('showEnhanced').addEventListener('click', function(ev){ ev.preventDefault(); postAndAction('here'); });

  try{
    const raw=sessionStorage.getItem('lastExtraction');
    if(raw){ const j=JSON.parse(raw); renderResponse(j); }
  }catch(e){}
});
</script>
</body>
</html>
