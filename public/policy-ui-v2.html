<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PIVOT Portability â€” Enhanced Demo (v2)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fb; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { border-radius: 12px; box-shadow: 0 6px 20px rgba(20,20,60,0.06); }
    .app-header { display:flex; align-items:center; justify-content:space-between; gap:16px; padding: 12px 8px; }
    .brand-left img { height:72px; width:auto; }
    .brand-center { flex:1 1 auto; text-align:center; }
    .product-meta { font-size:0.85rem; color:#6b7280; margin-bottom:4px; }
    .product-title { font-size:1.25rem; font-weight:700; margin:0; letter-spacing:0.2px; color:#111827; }
    .brand-right img.pivot { height:92px; width:auto; }
    .score-ring { width:120px; height:120px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .badge-accept { background:#e6f8ed; color:#08633a; padding:.45rem .7rem; border-radius:.6rem; }
    .badge-review { background:#fff7e6; color:#7a4b00; padding:.45rem .7rem; border-radius:.6rem; }
    .badge-reject { background:#ffecec; color:#7a1414; padding:.45rem .7rem; border-radius:.6rem; }
    .small-muted { font-size:.85rem; color:#6b7280; }
    .risk-badge { padding:.4rem .6rem; border-radius:.5rem; font-weight:600; }
    .timeline { height:10px; background:#eef2ff; border-radius:8px; position:relative; margin-top:8px; }
    .timeline .marker { position:absolute; top:-6px; width:12px; height:12px; border-radius:50%; background:#60a5fa; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .controls { gap:8px; display:flex; flex-wrap:wrap; }
    .decision-box { border-radius:8px; padding:12px; background:#fffbeb; border:1px solid #fcd34d; }
    .checks-list .item { padding:8px; border-radius:6px; margin-bottom:6px; background:#fff; border:1px solid #eef2ff; }
    .checks-list .item.error { border-color:#fecaca; background:#fff1f2; }
    .checks-list .item.warn { border-color:#fef3c7; background:#fffbeb; }
    @media (max-width: 900px) {
      .brand-left img { height:56px; }
      .brand-right img.pivot { height:64px; }
      .product-title { font-size:1.05rem; }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="card p-4">
      <div class="app-header">
        <div class="brand-left"><img src="company_logo.png" alt="company"></div>
        <div class="brand-center" role="banner"><div class="product-meta">Product</div><div class="product-title">PIVOT Portability module</div></div>
        <div class="brand-right"><img src="pivot_logo.png" alt="pivot" class="pivot"></div>
      </div>
      <hr>
      <!-- Before / After bar -->
      <div class="d-flex align-items-center justify-content-between mb-3 gap-3">
        <div style="flex:1">
          <div class="small-muted">Before</div>
          <div>Manual document reading, 10-30 min per policy, inconsistent results</div>
        </div>
        <div style="flex:0 0 240px; text-align:center; background:#f1f5f9; padding:10px; border-radius:8px;">
          <div class="small-muted">After PIVOT</div>
          <div style="font-weight:700; font-size:1.1rem;">Extract â†’ Score â†’ Validate in <span id="afterTime">~5s</span></div>
        </div>
        <div style="flex:1; text-align:right;">
          <div class="small-muted">Impact</div>
          <div>Consistency â†‘ â€¢ Turnaround â†“ â€¢ Audit trail</div>
        </div>
      </div>

      <!-- Form row -->
      <form id="demoForm" class="row g-2 align-items-end mb-3">
        <div class="col-md-4">
          <label class="form-label">Insurance company</label>
          <input id="insurance_company" class="form-control" placeholder="e.g. Star" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data type</label>
          <input id="data_type" class="form-control" placeholder="e.g. port-in" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">File</label>
          <input id="input_file" type="file" class="form-control" required>
          <div id="fileInfo" class="form-text"></div>
        </div>
        <div class="col-md-2 d-grid">
          <button id="submitBtn" class="btn btn-primary">Send to API</button>
        </div>
      </form>

      <div id="alerts"></div>

      <div class="row">
        <div class="col-md-4">
          <div class="text-center">
            <div id="scoreRing" class="score-ring mb-2" style="border:8px solid #f59e0b; border-radius:50%;">--%</div>
            <div id="decideBadge"></div>
            <div class="small-muted mt-2">Underwriter Score</div>
          </div>

          <div class="mt-3 decision-box" id="decisionBox">
            <div class="d-flex justify-content-between">
              <div><strong id="decisionLabel">REVIEW</strong><div class="small-muted">Recommended Action</div></div>
              <div id="decisionAction" style="font-weight:700">Check continuity & nominee</div>
            </div>
          </div>

          <div class="mt-3 controls">
            <button id="approveBtn" class="btn btn-success w-100">Approve</button>
            <button id="flagBtn" class="btn btn-warning w-100">Flag for manual review</button>
            <button id="exportPdf" class="btn btn-outline-secondary w-100">Export Underwriting Summary (Print/PDF)</button>
            <a id="downloadJson" class="btn btn-sm btn-outline-secondary w-100" download>Download JSON</a>
          </div>

          <div class="mt-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="showErrorsOnly">
              <label class="form-check-label small-muted" for="showErrorsOnly">Show errors only</label>
            </div>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="technicalMode">
              <label class="form-check-label small-muted" for="technicalMode">Technical view</label>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <h5>Policy summary</h5>
          <div class="card p-3 mb-3" id="policyCard">
            <div class="row">
              <div class="col-md-6">
                <div><strong>Policy number</strong> <div id="policyNumber" class="small-muted"></div></div>
                <div class="mt-2"><strong>Product</strong> <div id="productName" class="small-muted"></div></div>
              </div>
              <div class="col-md-6">
                <div><strong>Policy type</strong> <div id="policyType" class="small-muted"></div></div>
                <div class="mt-2"><strong>Term</strong> <div id="policyTerm" class="small-muted"></div></div>
              </div>
              <div class="col-12 mt-2">
                <strong>Period</strong>
                <div id="policyPeriod" class="small-muted"></div>
              </div>
              <div class="col-12 mt-2">
                <strong>Sum Insured</strong>
                <div id="sumInsured" class="small-muted"></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-7">
              <h6>Proposer</h6>
              <div class="card p-3 mb-3" id="proposerCard">
                <div id="proposerName" class="fw-semibold"></div>
                <div class="small-muted" id="proposerContact"></div>
                <div class="mt-2" id="proposerAddress"></div>
                <div class="mt-2 small-muted" id="proposerExtras"></div>
              </div>

              <h6>Insured members</h6>
              <div id="insuredList"></div>

              <h6 class="mt-3">Nominee</h6>
              <div class="card p-3" id="nomineeCard"></div>
            </div>

            <div class="col-md-5">
              <h6>Risk summary</h6>
              <div class="card p-3 mb-3">
                <div id="riskBadges" class="d-flex flex-column gap-2">
                  <!-- badges inserted here -->
                </div>
                <div class="mt-3">
                  <div class="small-muted">Continuity timeline</div>
                  <div class="timeline"><div id="timelineMarker" class="marker" style="left:50%"></div></div>
                </div>
              </div>

              <h6>Validation & checks</h6>
              <div id="checksList" class="checks-list mb-3"></div>

              <details id="technicalPanel" style="display:none;">
                <summary class="small-muted">Technical details</summary>
                <div class="p-2 bg-light rounded mt-2" id="techDetails"></div>
              </details>
            </div>
          </div>

          <details class="mt-2">
            <summary class="small-muted">Raw API JSON</summary>
            <pre id="rawJson" class="mt-2 bg-light p-2 rounded" style="max-height:300px; overflow:auto;"></pre>
          </details>
        </div>
      </div>
    </div>
  </div>

<script>
  // Helpers
  function el(id){return document.getElementById(id);}
  function parseDate(d){ if(!d) return null; const m=d.match(/(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})/); if(m) return new Date(Number(m[3]),Number(m[2])-1,Number(m[1])); const dt=new Date(d); return isNaN(dt)?null:dt; }
  function formatDate(dt){ if(!dt) return 'â€”'; return dt.toLocaleDateString(); }
  function parseNumber(s){ if(!s) return null; const n=Number(String(s).replace(/[â‚¹,\\s]/g,'')); return Number.isFinite(n)?n:null; }
  function validEmail(e){ return !!String(e).match(/^\\S+@\\S+\\.\\S+$/); }
  function validPhone(p){ return !!String(p).match(/^\\d{10}$/); }

  // Scoring (same logic as v1 but adds breakdown)
  function computeScore(data){
    let score=0;
    const reqs=[!!data.policy_and_coverage_details?.policy_number, !!data.policy_and_coverage_details?.policy_start_date, !!data.policy_and_coverage_details?.policy_end_date, !!data.proposer_details?.first_name, !!data.proposer_details?.dob, (data.insured_details && data.insured_details.length>0)];
    const reqScore=Math.round(30*(reqs.filter(Boolean).length/reqs.length)); score+=reqScore;
    let dateScore=0; const start=parseDate(data.policy_and_coverage_details?.policy_start_date); const end=parseDate(data.policy_and_coverage_details?.policy_end_date);
    if(start && end){ dateScore+=7; if(end>start) dateScore+=5; const declaredTerm=Number(data.policy_and_coverage_details?.policy_term||0); const years=Math.round((end-start)/(365*24*3600*1000)); if(!isNaN(declaredTerm) && Math.abs(years-declaredTerm)<=1) dateScore+=3; }
    score+=dateScore;
    let sumScore=0; const floaterSum=parseNumber(data.policy_and_coverage_details?.floater_basic_sum_insured); const indivSum=parseNumber(data.insured_details?.[0]?.individual_policy_sum_insured); const anySum = floaterSum ?? indivSum; if(anySum!=null){ sumScore+=10; if(!isNaN(anySum)) sumScore+=5; } score+=sumScore;
    let insScore=0; const ins=data.insured_details?.[0]; if(ins?.insured_name) insScore+=5; if(ins?.dob && ins?.age){ const dDob=parseDate(ins.dob); if(dDob){ const diffYears=Math.floor((new Date()-dDob)/(365*24*3600*1000)); const declaredAge=Number(ins.age); if(!isNaN(declaredAge) && Math.abs(declaredAge-diffYears)<=2) insScore+=5; } } else if(ins?.age) insScore+=2; if(ins?.individual_policy_sum_insured) insScore+=5; score+=insScore;
    let contactScore=0; const prop=data.proposer_details||{}; if(prop.mobile_number && validPhone(prop.mobile_number)) contactScore+=3; if(prop.email && validEmail(prop.email)) contactScore+=3; if(prop.pan || prop.aadhar) contactScore+=4; score+=contactScore;
    let nomineeScore=0; if(data.nominee_details && data.nominee_details.length>0){ const totalShare=(data.nominee_details||[]).reduce((s,n)=>s+(Number(n.nominee_share)||0),0); if(totalShare===100) nomineeScore=5; else nomineeScore=2; } score+=nomineeScore;
    let pedScore=0; const insPed=ins?.declared_ped||''; if(insPed.toLowerCase().includes('no ped')) pedScore=5; else if(!insPed) pedScore=2; score+=pedScore;
    let sellerScore=0; if(data.seller_details?.seller_name) sellerScore+=3; if(data.issuing_office_details?.office_name) sellerScore+=2; score+=sellerScore;
    return {score, breakdown:{reqScore,dateScore,sumScore,insScore,contactScore,nomineeScore,pedScore,sellerScore}};
  }

  // Render response - v2
  function renderResponse(resp, latencyMs){
    const data = resp?.response?.data || resp || {};
    const res = computeScore(data);
    const s = res.score;
    el('scoreRing').textContent = s + '%';
    el('scoreRing').style.border = '8px solid ' + (s>=85?'#16a34a':(s>=65?'#f59e0b':'#ef4444'));
    el('decideBadge').innerHTML = s>=85?'<div class="badge-accept">ACCEPT</div>':(s>=65?'<div class="badge-review">REVIEW</div>':'<div class="badge-reject">REJECT</div>');
    el('decisionLabel').textContent = s>=85?'ACCEPT':(s>=65?'REVIEW':'REJECT');
    el('decisionAction').textContent = s>=85?'Auto-approve (no human action)':'Check continuity & nominee age';
    // policy
    const pol = data.policy_and_coverage_details||{};
    el('policyNumber').textContent = pol.policy_number || 'â€”';
    el('productName').textContent = pol.policy_product_name || 'â€”';
    el('policyType').textContent = pol.policy_type || 'â€”';
    el('policyTerm').textContent = pol.policy_term || 'â€”';
    const start=parseDate(pol.policy_start_date); const end=parseDate(pol.policy_end_date);
    el('policyPeriod').textContent = (start?formatDate(start):pol.policy_start_date||'â€”') + ' â†’ ' + (end?formatDate(end):pol.policy_end_date||'â€”');
    const sIns = parseNumber(pol.floater_basic_sum_insured) ?? parseNumber(data.insured_details?.[0]?.individual_policy_sum_insured);
    el('sumInsured').textContent = sIns!=null ? 'â‚¹ ' + sIns.toLocaleString() : 'â€”';

    // proposer
    const p = data.proposer_details||{};
    el('proposerName').textContent = [p.title, p.first_name, p.last_name].filter(Boolean).join(' ') || 'â€”';
    el('proposerContact').textContent = (p.mobile_number? 'ðŸ“ž ' + p.mobile_number+' ' : '') + (p.email? ' âœ‰ï¸ ' + p.email : '');
    el('proposerAddress').textContent = (p.address? p.address+', ': '') + (p.city? p.city + ', ': '') + (p.state? p.state + ' ': '') + (p.pin_code? p.pin_code: '');
    el('proposerExtras').textContent = 'PAN: ' + (p.pan||'â€”') + ' â€¢ Aadhaar: ' + (p.aadhar||'â€”');

    // insureds
    const insuredList = el('insuredList'); insuredList.innerHTML='';
    (data.insured_details||[]).forEach(ins=>{
      const div=document.createElement('div'); div.className='card p-2 mb-2';
      div.innerHTML = `<div class="d-flex justify-content-between"><div><strong>${ins.insured_name||'â€”'}</strong><div class="small-muted">${ins.relationship||''} â€¢ DOB: ${ins.dob||'â€”'}</div></div><div class="text-end"><div>Age: ${ins.age||'â€”'}</div><div>SI: ${ins.individual_policy_sum_insured||'â€”'}</div></div></div><div class="mt-2 small-muted">PED: ${ins.declared_ped||'â€”'}</div>`;
      insuredList.appendChild(div);
    });

    // nominee
    const nomCard = el('nomineeCard'); nomCard.innerHTML='';
    (data.nominee_details||[]).forEach(n=>{
      const dv=document.createElement('div'); dv.className='mb-1'; dv.innerHTML=`<strong>${n.nominee_name||n.nominee_name||'â€”'}</strong> <div class="small-muted">${n.nominee_relation||''} â€¢ Age: ${n.nominee_age||'â€”'} â€¢ Share: ${n.nominee_share||'â€”'}%</div>`; nomCard.appendChild(dv);
    });

    // risk badges
    const badges = [];
    const ins0 = data.insured_details?.[0];
    if(ins0 && ins0.declared_ped && !ins0.declared_ped.toLowerCase().includes('no ped')) badges.push({text:'PED: Declared', cls:'bg-danger text-white'});
    else badges.push({text:'PED: None', cls:'bg-success text-white'});
    if(ins0 && ins0.dob && ins0.age){ const d=parseDate(ins0.dob); if(d){ const calc=Math.floor((new Date()-d)/(365*24*3600*1000)); if(Math.abs(calc - Number(ins0.age))>2){ badges.push({text:'Age mismatch', cls:'bg-warning text-dark'}); } else badges.push({text:'Age match', cls:'bg-success text-white'}); } } else { badges.push({text:'Age unknown', cls:'bg-secondary text-white'}); }
    if(pol.previous_policy_number) badges.push({text:'Continuity: Found', cls:'bg-success text-white'}); else badges.push({text:'Continuity: Unknown', cls:'bg-warning text-dark'});
    if(sIns!=null) badges.push({text:'Sum Insured: OK', cls:'bg-info text-white'}); else badges.push({text:'Sum Insured: Missing', cls:'bg-danger text-white'});

    const rb = el('riskBadges'); rb.innerHTML=''; badges.forEach(b=>{ const sp=document.createElement('span'); sp.className='risk-badge ' + b.cls; sp.style.marginRight='6px'; sp.textContent=b.text; rb.appendChild(sp); });

    // checks list
    const checks=[];
    if(!pol.policy_number) checks.push({level:'error', text:'Missing policy number'});
    if(!start) checks.push({level:'error', text:'Start date not parseable'});
    if(!end) checks.push({level:'error', text:'End date not parseable'});
    if(start && end && end<start) checks.push({level:'error', text:'End date is before start date'});
    if(sIns==null) checks.push({level:'error', text:'Sum insured missing'});
    if(ins0 && ins0.age && ins0.dob){ const dob=parseDate(ins0.dob); if(dob){ const calcAge=Math.floor((new Date()-dob)/(365*24*3600*1000)); if(Math.abs(calcAge - Number(ins0.age))>2) checks.push({level:'warn', text:'Insured age differs from DOB'}); } }
    const prop = data.proposer_details||{};
    if(!prop.mobile_number || !validPhone(prop.mobile_number)) checks.push({level:'warn', text:'Proposer phone missing or invalid'});
    if(!prop.email || !validEmail(prop.email)) checks.push({level:'warn', text:'Proposer email missing or invalid'});
    if(!prop.pan && !prop.aadhar) checks.push({level:'warn', text:'PAN/Aadhaar missing'});
    const totalShare = (data.nominee_details||[]).reduce((s,n)=> s + (Number(n.nominee_share)||0), 0);
    if((data.nominee_details||[]).length===0) checks.push({level:'warn', text:'No nominee found'}); else if(totalShare!==100) checks.push({level:'warn', text:'Nominee share does not total 100%'});
    if(ins0 && ins0.declared_ped && !ins0.declared_ped.toLowerCase().includes('no ped')) checks.push({level:'warn', text:'PED declared â€” requires review'});

    const checksList = el('checksList'); checksList.innerHTML='';
    const showErrorsOnly = el('showErrorsOnly').checked;
    const filtered = showErrorsOnly ? checks.filter(c=>c.level!=='warn') : checks;
    if(filtered.length===0) checksList.innerHTML='<div class="p-2 bg-light rounded">No issues found.</div>'; else {
      filtered.forEach(c=>{ const div=document.createElement('div'); div.className='item '+(c.level==='error'?'error':(c.level==='warn'?'warn':'')); div.textContent = c.text; checksList.appendChild(div); });
    }

    el('rawJson').textContent = JSON.stringify(resp, null, 2);
    el('techDetails').innerHTML = `<div>Endpoint: /forward</div><div>Latency: ${latencyMs}ms</div><div>Score breakdown: ${JSON.stringify(res.breakdown)}</div>`;
    const marker = el('timelineMarker'); marker.style.left = (pol.previous_policy_number ? '80%' : '50%');
    const blob = new Blob([JSON.stringify(resp, null, 2)], {type:'application/json'}); el('downloadJson').href = URL.createObjectURL(blob); el('downloadJson').download = (pol.policy_number||'extraction') + '.json';
  }

  // Form submit and API call
  document.getElementById('demoForm').addEventListener('submit', async function(e){
    e.preventDefault();
    el('alerts').innerHTML='';
    const fd = new FormData();
    const f = el('input_file').files[0];
    if(!f){ alert('Please choose file'); return; }
    fd.append('input_file', f);
    fd.append('insurance_company', el('insurance_company').value);
    fd.append('data_type', el('data_type').value);
    const submitBtn = el('submitBtn'); submitBtn.disabled=true; submitBtn.textContent='Sending...';
    const t0 = performance.now();
    try{
      const resp = await fetch('/forward', { method:'POST', body: fd });
      const t1 = performance.now();
      const latency = Math.round(t1 - t0);
      const text = await resp.text();
      let json = null;
      try{ json = JSON.parse(text); } catch(e){ json = text; }
      if(!resp.ok){
        el('alerts').innerHTML = `<div class="alert alert-danger">Error ${resp.status}: <pre>${JSON.stringify(json, null, 2)}</pre></div>`;
      } else {
        renderResponse(json, latency);
        document.getElementById('technicalMode').addEventListener('change', function(){ el('technicalPanel').style.display = this.checked ? 'block' : 'none'; });
        document.getElementById('showErrorsOnly').addEventListener('change', function(){ renderResponse(json, latency); });
      }
    }catch(err){
      el('alerts').innerHTML = `<div class="alert alert-danger">Network: ${err.message}</div>`;
    }finally{
      submitBtn.disabled=false; submitBtn.textContent='Send to API';
    }
  });

  // Export PDF: print summary
  document.getElementById('exportPdf').addEventListener('click', function(){
    const summary = document.querySelector('#policyCard').outerHTML + document.querySelector('#proposerCard').outerHTML + document.querySelector('#insuredList').outerHTML;
    const w = window.open('', '_blank');
    w.document.write(`<html><head><title>Underwriting Summary</title><style>body{font-family:Arial;padding:20px;} .card{border:1px solid #ddd;padding:10px;margin-bottom:10px;border-radius:6px;}</style></head><body><h2>Underwriting Summary</h2>${summary}<script>window.print()</script></body></html>`);
    w.document.close();
  });

  // Approve / Flag demo handlers
  el('approveBtn').addEventListener('click', ()=> alert('Approved (demo)'));
  el('flagBtn').addEventListener('click', ()=> alert('Flagged for manual review (demo)'));
</script>
</body>
</html>
